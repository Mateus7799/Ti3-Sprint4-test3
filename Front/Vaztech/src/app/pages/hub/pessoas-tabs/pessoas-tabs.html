<p-toast />
<main>
  <p-toolbar>
    <ng-template #start>
      <section>
        <p-iconfield iconPosition="left">
          <p-inputicon class="pi pi-search" />
          <input
            [(ngModel)]="searchText"
            (ngModelChange)="filtrarPessoas()"
            type="text"
            pInputText
            placeholder="Pesquisar"
            class="w-96"
          />
        </p-iconfield>
      </section>
    </ng-template>
    <ng-template #end>
      <p-button
        label="Cadastrar Pessoa"
        icon="pi pi-plus"
        (click)="abrirModalCadastrar()"
      ></p-button>
    </ng-template>
  </p-toolbar>

  <div class="flex gap-4 flex-wrap pt-4 pb-4">
    @if (pessoasPaginadas.length > 0) {
      @for (pessoa of pessoasPaginadas; track pessoa.id) {
        <p-card [style]="{ width: '25rem', overflow: 'hidden' }">
          <ng-template #title>
            <section class="flex justify-between items-center">
              <div>
                <span class="font-bold">{{ pessoa.nome }}</span>
              </div>
              <p-button
                icon="pi pi-pen-to-square"
                [text]="true"
                severity="secondary"
                [rounded]="true"
                (click)="abrirModalEditar(pessoa)"
              ></p-button>
            </section>
          </ng-template>
          <ng-template #subtitle>
            <span class="text-sm text-gray-600">{{ pessoa.origem || 'Sem origem definida' }}</span>
          </ng-template>
          <div class="space-y-2">
            <p><strong>CPF/CNPJ:</strong> {{ pessoa.cpfCnpj | cpfCnpj }}</p>
            @if (pessoa.dataNascimento) {
              <p class="text-sm text-gray-600"><strong>Data de Nascimento:</strong> {{ pessoa.dataNascimento }}</p>
            }
          </div>
        </p-card>
      }
    } @else {
      <p-card header="Não há pessoas cadastradas!" class="w-full">
        <p class="m-0">
          Comece a adicionar pessoas no sistema para vê-las aqui!
        </p>
      </p-card>
    }
  </div>

  @if (totalRegistros > itensPorPagina) {
    <div class="flex justify-center pt-4">
      <p-paginator
        [rows]="itensPorPagina"
        [totalRecords]="totalRegistros"
        [rowsPerPageOptions]="[6, 12, 24]"
        (onPageChange)="onPageChange($event)"
      ></p-paginator>
    </div>
  }

  <p-dialog
    [header]="editandoPessoa ? 'Editar Pessoa' : 'Cadastrar Nova Pessoa'"
    (onHide)="esconderFormularioModal(pessoaForm)"
    [modal]="true"
    [(visible)]="modalFormularioAberto"
    [draggable]="false"
    [style]="{ width: '35rem' }"
  >
    <form
      #pessoaForm="ngForm"
      class="flex flex-col w-full space-y-4"
      (ngSubmit)="enviarFormulario(pessoaForm)"
    >
      <div class="flex flex-col space-y-2">
        <label for="nome" class="font-semibold">Nome *</label>
        <input
          [ngModel]="editandoPessoa?.nome"
          required
          name="nome"
          id="nome"
          type="text"
          placeholder="Nome completo..."
          pInputText
        />
      </div>

      <div class="flex flex-col space-y-2">
        <label for="cpfCnpj" class="font-semibold">CPF/CNPJ *</label>
        <p-inputmask
          [ngModel]="editandoPessoa?.cpfCnpj"
          (ngModelChange)="onCpfCnpjChange($event)"
          required
          name="cpfCnpj"
          id="cpfCnpj"
          [mask]="cpfMask"
          placeholder="Digite CPF ou CNPJ"
          styleClass="w-full"
        ></p-inputmask>
        <small class="text-gray-500">{{ isCnpj ? 'CNPJ' : 'CPF' }}</small>
      </div>

      <div class="flex flex-col space-y-2">
        <label for="dataNascimento" class="font-semibold">Data de Nascimento</label>
        <input
          [ngModel]="editandoPessoa?.dataNascimento"
          name="dataNascimento"
          id="dataNascimento"
          type="date"
          pInputText
        />
      </div>

      <div class="flex flex-col space-y-2">
        <label for="origem" class="font-semibold">Origem</label>
        <input
          [ngModel]="editandoPessoa?.origem"
          name="origem"
          id="origem"
          type="text"
          placeholder="Origem da pessoa (Cliente, Fornecedor, etc.)"
          pInputText
        />
      </div>

      <div class="flex justify-end gap-2 pt-4">
        <p-button
          label="Cancelar"
          severity="secondary"
          [outlined]="true"
          (click)="modalFormularioAberto = false; esconderFormularioModal(pessoaForm)"
        ></p-button>
        <p-button
          [label]="editandoPessoa ? 'Salvar Edições' : 'Cadastrar'"
          type="submit"
          [disabled]="pessoaForm.invalid"
        ></p-button>
      </div>
    </form>
  </p-dialog>
</main>
